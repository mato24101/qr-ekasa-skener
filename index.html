<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Kód Skener a Spracovanie Dát (PWA)</title>
    
    <base href="/qr-ekasa-skener/">

    <link rel="manifest" href="manifest.json">
    
    <meta name="theme-color" content="#4f46e5"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        /* Štýlovanie pre oblasť skenovania */
        #reader > div:first-child {
            border-radius: 0.75rem !important; /* rounder-xl */
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2
             text-center">
            Bločko skener
        </h1>
        <p class="text-center text-gray-500 mb-8">
            Naskenuj eKasa QR kód alebo zadaj KB kód ručne a vygeneruje si link pre Cashew App.
        </p>

        <div class="flex flex-col md:flex-row gap-8">
            
            <div class="md:w-1/2 scanner-container">
                <div id="reader" class="rounded-xl shadow-lg border-4 border-indigo-200"></div>
                <div id="camera-error" class="mt-4 text-center p-3 rounded-lg text-red-700 bg-red-100 font-semibold hidden"></div>
            </div>

            <div class="md:w-1/2 flex flex-col gap-6">
                
                <!-- NEW: Manuálne zadanie KB kódu -->
                <div class="bg-blue-50 p-5 rounded-lg border border-blue-200 shadow-inner">
                    <h2 class="text-xl font-bold text-blue-800 mb-2">1. Manuálne Zadanie KB Kódu</h2>
                    <p class="text-sm text-blue-600 mb-3">
                        Zadajte eKasa KB kód ručne, ak sa QR kód nedá naskenovať.
                    </p>
                    <input type="text" id="kb-input" placeholder="Zadajte 18-miestny KB kód..." class="w-full p-2 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm text-gray-800 mb-4"/>
                    <button id="submit-kb-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        Spracovať kód
                    </button>
                </div>
                
                <!-- Pôvodný KB Kód (zobrazenie) -->
                <div id="qr-content-card" class="bg-indigo-50 p-5 rounded-lg border border-indigo-200 shadow-inner hidden">
                    <h2 class="text-xl font-bold text-indigo-800 mb-2">2. KB Kód (Vstup)</h2>
                    <p class="text-sm text-indigo-600 mb-3">Surové dáta extrahované skenerom / zadané ručne:</p>
                    <div id="qr-content" class="bg-white p-3 min-h-[4rem] rounded-md border border-indigo-300 font-mono text-gray-800 break-all flex items-center justify-center text-center text-sm">
                        <span class="text-gray-400">Čakám na sken...</span>
                    </div>
                </div>

                <!-- API Finančnej správy -->
                <div id="api-output-card" class="bg-emerald-50 p-5 rounded-lg border border-emerald-200 shadow-inner hidden">
                    <h2 class="text-xl font-bold text-emerald-800 mb-2">3. Výsledky Spracovania (API volanie)</h2>
                    <p class="text-sm text-emerald-600 mb-3">
                        Dáta boli odoslané na API Finančnej správy a bol získaný výstup.
                    </p>
                    <div id="python-output" class="bg-white p-3 min-h-[6rem] rounded-md border border-emerald-300 whitespace-pre-wrap text-gray-800 text-sm">
                        <span class="text-gray-400">Výsledok API volania.</span>
                    </div>
                </div>

                <!-- NEW: Gemini AI Categorization -->
                <div id="gemini-output-card" class="bg-purple-50 p-5 rounded-lg border border-purple-200 shadow-inner hidden">
                    <h2 class="text-xl font-bold text-purple-800 mb-2">4. Gemini AI Kategorizácia (JSON)</h2>
                    <p class="text-sm text-purple-600 mb-3">
                        Položky bločku roztriedené AI do kategórií s celkovými súčtami:
                    </p>
                    <div id="gemini-output" class="bg-white p-3 min-h-[6rem] rounded-md border border-purple-300 whitespace-pre-wrap text-gray-800 text-xs font-mono overflow-auto max-h-60">
                        <span class="text-gray-400">Výsledok kategorizácie AI.</span>
                    </div>
                </div>


                <!-- Pôvodné Nastavenia Transakcie -->
                <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200 shadow-inner">
                    <h2 class="text-xl font-bold text-yellow-800 mb-4">Nastavenia Transakcie</h2>
                    
                    <div class="mb-4">
                        <label for="category-select" class="block text-sm font-medium text-yellow-700 mb-1">Kategória / Subkategória:</label>
                        <select id="category-select" class="w-full p-2 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150 shadow-sm text-gray-800">
                            </select>
                    </div>

                    <div>
                        <label for="account-select" class="block text-sm font-medium text-yellow-700 mb-1">Účet (Account):</label>
                        <select id="account-select" class="w-full p-2 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150 shadow-sm text-gray-800">
                            </select>
                    </div>
                </div>

                <!-- Pôvodný Deeplink Card -->
                <div id="deeplink-card" class="bg-blue-50 p-5 rounded-lg border border-blue-200 shadow-inner hidden">
                    <h2 class="text-xl font-bold text-blue-800 mb-2">5. Generovaný Cashew Link (HTTPS)</h2>
                    <p class="text-sm text-blue-600 mb-3">
                        HTTPS URI vytvorená pre mobilnú aplikáciu Cashew s parametrami pre transakciu:
                    </p>
                    <div id="deeplink-output" class="bg-white p-3 rounded-md border border-blue-300 font-mono text-xs text-gray-800 break-all mb-4">
                        <span class="text-gray-400">Deeplink sa vygeneruje po úspešnom spracovaní.</span>
                    </div>
                    <a id="open-deeplink-button" href="#" target="_blank" class="block text-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        Import to Cashew (Vyskúšať)
                    </a>
                </div>

                <button id="reset-button" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md">
                    Spustiť nové skenovanie / Reštartovať
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        
        // Globálne premenné pre Firebase (použité len na inicializáciu)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Konštanta pre Cashew App Link URI (Aktualizované na HTTPS transakčný endpoint)
        const DEEP_LINK_SCHEME = "https://cashewapp.web.app/addTransaction";
        
        // *** DÔLEŽITÉ PRE NASADENIE NA GITHUB PAGES / NETLIFY / VERCEL ***
        // Pri nasadení na statický hosting (mimo Canvas) musíte klientske volania 
        // presmerovať cez serverless funkciu (backend proxy), ktorá bezpečne drží Váš API kľúč.
        // Cesta je príklad pre Netlify Functions:
        const PROXY_ENDPOINT = "/.netlify/functions/gemini-proxy"; 
        
        // Pôvodné konštanty GEMINI_API_URL a API_KEY sú odstránené, pretože 
        // sa už nepoužívajú pri volaní priamo z prehliadača.

        // Hardcoded kategórie/subkategórie pre dropdown
        const CATEGORY_MAP = {
            'Jedlo (Groceries)': { type: 'category', value: 'Groceries' },
            'Obed (Lunch)': { type: 'subcategory', value: 'Lunch' },
            'Fastfood': { type: 'subcategory', value: 'Fastfood' },
            'Reštaurácia (Dining)': { type: 'category', value: 'Dining' },
            'Nákup (Shopping)': { type: 'category', value: 'Shopping' },
            'Vylepšenie domácnosti': { type: 'subcategory', value: 'Home improvements' },
            'Nábytok': { type: 'subcategory', value: 'Furniture' },
            'Oblečenie': { type: 'subcategory', value: 'Clothing' },
            'Elektronika': { type: 'subcategory', value: 'Electonics' },
            'Drogéria': { type: 'subcategory', value: 'Drugstore' },
            'Hračky': { type: 'subcategory', value: 'Toys' },
            'Tankovanie': { type: 'subcategory', value: 'Gas' },
            'Zvieratká (Pets)': { type: 'category', value: 'Pets' },
            'Zábava (Enterteinment)': { type: 'category', value: 'Enterteinment' },
            'Darčeky (Gifts)': { type: 'category', value: 'Gifts' },
            'Krása (Beauty)': { type: 'category', value: 'Beauty' },
            'Lieky': { type: 'subcategory', value: 'Medicine' },
            'Zubár': { type: 'subcategory', value: 'Dentist' },
            'Lekár (Health)': { type: 'category', value: 'Health' },
        };

        // Zjednodušené kategórie pre Gemini LLM
        const GEMINI_CATEGORIES = [
            'Groceries', 'Dining', 'Shopping', 'Health', 'Pets', 'Enterteinment', 'Gifts', 'Beauty', 'Uncategorized'
        ];

        // Hardcoded účty pre dropdown
        const ACCOUNTS = [
            'Xtb', // Predvolený účet by mal byť hore
            '365',
            'Cash'
        ];


        /**
         * Dynamicky naplní dropdown menu kategóriami a účtami.
         */
        function populateDropdowns() {
            const categorySelect = document.getElementById('category-select');
            const accountSelect = document.getElementById('account-select');

            // 1. Naplnenie Kategórií/Subkategórií
            for (const [label, data] of Object.entries(CATEGORY_MAP)) {
                const option = document.createElement('option');
                // Ukladáme celú štruktúru ako JSON string, aby sme vedeli, či ide o 'category' alebo 'subcategory'
                option.value = JSON.stringify(data); 
                option.textContent = label;
                categorySelect.appendChild(option);
            }
            
            // Predvolene nastavíme 'Nakup (Shopping)'
            const defaultOption = categorySelect.querySelector(`[value*='"Groceries"'][value*='"category"']`) || categorySelect.options[0];
            if (defaultOption) {
                defaultOption.selected = true;
            }


            // 2. Naplnenie Účtov
            ACCOUNTS.forEach((account, index) => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountSelect.appendChild(option);
                // Nastavíme prvý účet ako predvolený
                if (index === 0) {
                    option.selected = true;
                }
            });
        }


        /**
         * Odstráni diakritiku (mäkčene a dĺžne) zo slovenského textu.
         * @param {string} text Vstupný text.
         * @returns {string} Text bez diakritiky.
         */
        function removeDiacritics(text) {
            if (!text) return '';
            // Normalizácia NFKD a odstránenie diakritických značiek
            const normalized = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return normalized;
        }

        /**
         * Generuje Cashew transakčný link na základe získaných dát a výberu používateľa.
         * @param {string} kb_code Kód bločku.
         * @param {string} issueDate Dátum vystavenia.
         * @param {string} shopName Názov predajne.
         * @param {string} totalPrice Celková cena.
         * @returns {string} Generovaný Deep Link URI.
         */
        function generateDeepLink(kb_code, issueDate, shopName, totalPrice) {
            
            // Načítanie vybraných hodnôt
            const categorySelect = document.getElementById('category-select');
            const accountSelect = document.getElementById('account-select');

            const selectedCategoryData = JSON.parse(categorySelect.value);
            const selectedAccount = accountSelect.value;

            // 1. Spracovanie názvu (bez diakritiky)
            const title = removeDiacritics(shopName);

            // 2. Spracovanie sumy (záporná hodnota pre výdavok)
            // Nahradíme čiarku za bodku pre správny desatinný formát a pridáme mínus
            const amount = "-" + String(totalPrice).replace(',', '.'); 
            
            // 3. Vytvorenie poznámky
            const notes = `eKasa Blok ID: ${kb_code}`; 

            // 4. Manuálna konštrukcia základných parametrov
            const params = [
                `amount=${encodeURIComponent(amount)}`,
                `title=${encodeURIComponent(title)}`,
                `notes=${encodeURIComponent(notes)}`,
                `account=${encodeURIComponent(selectedAccount)}`, // Pridanie nového account parametra
                `date=${encodeURIComponent(issueDate)}`
            ];

            // 5. Pridanie category alebo subcategory na základe výberu
            if (selectedCategoryData.type === 'category') {
                // Príklad: category=Groceries
                params.push(`category=${encodeURIComponent(selectedCategoryData.value)}`);
            } else if (selectedCategoryData.type === 'subcategory') {
                // Pridáme len subcategory parameter
                params.push(`subcategory=${encodeURIComponent(selectedCategoryData.value)}`);
            }

            // Vrátenie kompletnej URI (so správne kódovanými medzerami ako %20)
            return `${DEEP_LINK_SCHEME}?${params.join('&')}`;
        }

        /**
         * Funkcia, ktorá vykonáva asynchrónne volanie na API Finančnej správy.
         * @param {string} kb_code Kód bločku z QR kódu (KB kód).
         * @returns {Promise<{issueDate: string, shopName: string, totalPrice: string, items: Array<{itemName: string, totalPrice: string}>} | null>} Získané dáta.
         */
        async function fetchReceiptData(kb_code) {
            const url = "https://ekasa.financnasprava.sk/mdu/api/v1/opd/receipt/find";
            const payload = { "receiptId": kb_code };
            const headers = {
                "Content-Type": "application/json;charset=UTF-8",
                "Accept": "application/json, text/plain, */*",
                "Origin": "https://opd.financnasprava.sk",
                "Referer": "https://opd.financnasprava.sk/",
                "User-Agent": navigator.userAgent 
            };

            const outputElement = document.getElementById('python-output');
            
            // Indikátor načítania
            outputElement.textContent = 'Načítavam dáta z Finančnej správy (API volanie)...';
            outputElement.classList.remove('text-gray-800', 'text-red-700', 'font-mono');
            outputElement.classList.add('text-yellow-600', 'animate-pulse');

            try {
                // Implementácia exponenciálneho backoffu (max 3 pokusy)
                for (let attempt = 0; attempt < 3; attempt++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(payload),
                            signal: AbortSignal.timeout(10000) // Timeout 10 sekúnd
                        });

                        // 429 Too Many Requests -> skúsime znova s oneskorením
                        if (response.status === 429 && attempt < 2) { 
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`Chyba pri HTTP požiadavke. Status kód: ${response.status} ${response.statusText}`);
                        }

                        const data = await response.json();

                        if (data.returnValue === 0 && data.receipt && data.receipt.organization && data.receipt.items) {
                            
                            const issueDate = data.receipt.issueDate || 'N/A';
                            const shopName = data.receipt.organization.name || 'N/A';
                            const totalPrice = data.receipt.totalPrice || 'N/A';
                            
                            // *** KĽÚČOVÁ ZMENA: Extrahovanie položiek ***
                            const items = data.receipt.items.map(item => ({
                                itemName: item.name,
                                totalPrice: item.price // cena položky (string/number)
                            }));

                            // --- NOVÁ ČASŤ: Formátovanie položiek pre výpis ---
                            const formattedItems = items.map(item => 
                                `${item.itemName}: ${item.totalPrice} EUR`
                            ).join('\n  '); // Indent pre lepšiu čitateľnosť

                            const resultText = `
Dáta z QR kódu (KB kód): ${kb_code}

--- VÝSLEDOK API VOLANIA ---
Dátum vystavenia (issueDate): ${issueDate}
Názov predajne (sellerName): ${shopName}
Celková cena (totalPrice): ${totalPrice}
Počet položiek: ${items.length}

Položky bločku:
  ${formattedItems}
                            `.trim();
                            // --- KONIEC NOVEJ ČASTI ---

                            outputElement.textContent = resultText;
                            outputElement.classList.remove('text-yellow-600', 'animate-pulse');
                            outputElement.classList.add('font-mono', 'text-sm', 'text-gray-800');

                            // Vrátime aj items
                            return { issueDate, shopName, totalPrice, items };
                        } else {
                            const errorText = `
CHYBA PRI DÁTACH:
Finančná správa vrátila neplatnú odpoveď alebo bloček nebol nájdený.
Návratová hodnota: ${data.returnValue}
Správa: ${data.returnMessage || 'Neznáma chyba'}
                            `.trim();
                            outputElement.textContent = errorText;
                            outputElement.classList.remove('text-yellow-600', 'animate-pulse');
                            outputElement.classList.add('text-red-700', 'font-mono', 'text-sm');
                            return null;
                        }
                    } catch (e) {
                        if (e.name === 'AbortError') {
                            throw new Error("Vypršal časový limit (10s) pre API volanie.");
                        }
                        if (attempt === 2) throw e; 
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

            } catch (e) {
                const errorText = `
CHYBA PRI VOLANÍ API:
Nepodarilo sa pripojiť k serveru alebo: ${e.message}
                `.trim();
                outputElement.textContent = errorText;
                outputElement.classList.remove('text-yellow-600', 'animate-pulse');
                outputElement.classList.add('text-red-700', 'font-mono', 'text-sm');
                console.error("Fetch Error:", e);
                return null;
            }
        }


        /**
         * Volá Gemini API na kategorizáciu položiek bločku.
         * Pri nasadení na GitHub Pages sa toto volanie presmeruje na Váš backend proxy.
         * @param {Array<{itemName: string, totalPrice: string}>} items Zoznam položiek bločku.
         * @returns {Promise<Object | null>} Kategorizované dáta alebo null pri chybe.
         */
        async function callGeminiCategorization(items) {
            const outputElement = document.getElementById('gemini-output');
            const geminiCard = document.getElementById('gemini-output-card');
            
            geminiCard.classList.remove('hidden');
            outputElement.textContent = 'Volám Gemini AI na kategorizáciu (generovanie JSON)...';
            outputElement.classList.remove('text-gray-800', 'text-red-700', 'font-mono');
            outputElement.classList.add('text-purple-600', 'animate-pulse');

            const itemText = items.map(item => `- ${item.itemName} (${item.totalPrice} EUR)`).join('\n');
            const categoriesText = GEMINI_CATEGORIES.join(', ');

            // 1. Definícia Systémovej Inštrukcie a Promptu
            const systemPrompt = `Si finančný analytik. Tvojou úlohou je roztriediť položky bločku do jednej z nasledujúcich kategórií: ${categoriesText}. Položky, ktoré nepasujú, zaraď do 'Uncategorized'. Následne pre každú kategóriu spočítaj celkovú sumu. Tvoj výstup MUSÍ byť čistý, validný JSON objekt, ktorý presne zodpovedá definovanej schéme. Výstup NEsmie obsahovať žiadne iné texty, vysvetlenia ani Markdown.`;
            const userQuery = `Roztrieď a spočítaj sumy pre kategórie. Vstup je: \n${itemText}`;
            
            // 2. Definícia JSON Schémy pre štruktúrovaný výstup
            const responseSchema = {
                type: "ARRAY",
                description: "Zoznam kategórií s ich celkovými súčtami. Pole musí obsahovať každú z kategórií, aj keď je suma 0.",
                items: {
                    type: "OBJECT",
                    properties: {
                        "category": { 
                            "type": "STRING", 
                            "description": `Názov kategórie. Musí byť jedna z: ${GEMINI_CATEGORIES.join(', ')}.`
                        },
                        "totalAmount": { 
                            "type": "NUMBER", 
                            "description": "Celková suma (sum) pre všetky položky v danej kategórii. Použi bodku ako desatinný oddeľovač (napr. 15.50)."
                        },
                        "items": {
                            "type": "ARRAY",
                            "description": "Zoznam položiek, ktoré patria do tejto kategórie (iba názov položky a jej cena).",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "name": { "type": "STRING" },
                                    "price": { "type": "STRING" }
                                }
                            }
                        }
                    },
                    "required": ["category", "totalAmount", "items"]
                }
            };
            
            // 3. Konštrukcia Payloadu pre PROXY
            // Odosielame prompt a schému na náš vlastný backend/proxy.
            const payloadForProxy = {
                systemPrompt: systemPrompt,
                userQuery: userQuery,
                responseSchema: responseSchema
            };

            const apiUrl = PROXY_ENDPOINT; // Voláme vlastný proxy server
            let finalResult = null;

            // 4. Implementácia exponenciálneho backoffu (max 3 pokusy)
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadForProxy),
                        signal: AbortSignal.timeout(15000) // Timeout 15 sekúnd
                    });

                    if (response.status === 429 && attempt < 2) { 
                        const delay = Math.pow(2, attempt) * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        // Ak proxy vráti chybu (napr. 500), dostaneme ju tu.
                        const errorBody = await response.text();
                        throw new Error(`Proxy Error: ${response.status} ${response.statusText}. Response: ${errorBody.substring(0, 100)}...`);
                    }

                    // Očakávame, že proxy nám vráti PRIAMO čistý JSON objekt (už spracovaný)
                    finalResult = await response.json();
                    
                    if (finalResult) {
                        break; // Úspech
                    } else {
                         throw new Error("Proxy vrátilo prázdnu alebo neplatnú odpoveď.");
                    }

                } catch (e) {
                    if (attempt === 2) {
                        outputElement.textContent = `
CHYBA KATEGORIZÁCIE:
Nepodarilo sa spustiť AI. Chyba: ${e.message}
                        `.trim();
                        outputElement.classList.remove('text-purple-600', 'animate-pulse');
                        outputElement.classList.add('text-red-700', 'font-mono');
                        console.error("Gemini Proxy Error:", e);
                        return null;
                    }
                    // Pokračujeme na ďalší pokus
                    const delay = Math.pow(2, attempt) * 1000 + 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            if (finalResult) {
                 // Zobrazenie naformátovaného JSON
                const formattedJson = JSON.stringify(finalResult, null, 2);
                outputElement.textContent = formattedJson;
                outputElement.classList.remove('text-purple-600', 'animate-pulse');
                outputElement.classList.add('font-mono', 'text-gray-800');
            }

            return finalResult;
        }
        
        /**
         * Spracuje manuálne zadaný KB kód.
         */
        function handleManualInput() {
            const kbInput = document.getElementById('kb-input');
            const kbCode = kbInput.value.trim();
            const errorElement = document.getElementById('camera-error');
            
            errorElement.classList.add('hidden'); // Skryjeme predchádzajúce chyby kamery

            if (!kbCode) {
                errorElement.textContent = "CHYBA: Zadajte KB kód (nesmie byť prázdny).";
                errorElement.classList.remove('hidden');
                return;
            }

            // 1. Zastavíme skener, ak beží
            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.clear().catch(e => console.warn("Skener sa nepodarilo zastaviť po manuálnom zadaní:", e));
                } catch (e) {
                    // Ignorujeme
                }
            }

            // 2. Spustíme rovnakú logiku spracovania ako pri skenovaní
            // Použijeme onScanSuccess s null pre decodedResult
            onScanSuccess(kbCode, null); 
        }


        let html5QrcodeScanner;

        /**
         * Funkcia volaná po úspešnom skenovaní QR kódu (alebo manuálnom zadaní).
         * @param {string} decodedText Obsah QR kódu.
         * @param {any} decodedResult Výsledok skenovania (null pri manuálnom zadaní).
         */
        async function onScanSuccess(decodedText, decodedResult) {
            
            // Ak je decodedResult null, skenovanie neprebehlo (bolo manuálne), takže skener už nečistíme
            if (decodedResult !== null && html5QrcodeScanner) {
                try {
                    // Krok 1a: Bezpečne ukončíme skener, ak sme ho použili
                    await html5QrcodeScanner.clear();
                } catch(err) {
                    console.warn("Skener sa nepodarilo vyčistiť po skenovaní:", err);
                }
            }

            try {
                // Krok 1b: Aktualizácia UI
                document.getElementById('qr-content').textContent = decodedText;
                document.getElementById('qr-content').classList.remove('text-gray-400');
                document.getElementById('qr-content-card').classList.remove('hidden'); 
                document.getElementById('api-output-card').classList.remove('hidden'); 

                // Krok 2: Odoslanie dát na spracovanie cez API (získame aj položky)
                const receiptData = await fetchReceiptData(decodedText);

                if (receiptData) {
                        // Krok 3: Volanie Gemini AI pre kategorizáciu
                    await callGeminiCategorization(receiptData.items);
                    
                    // Krok 4: Generovanie Deep Link
                    const deeplinkCard = document.getElementById('deeplink-card');
                    const deeplinkOutput = document.getElementById('deeplink-output');
                    const deeplinkButton = document.getElementById('open-deeplink-button');

                    // Použijeme získané dáta na vytvorenie Deep Linku
                    const deeplink = generateDeepLink(decodedText, receiptData.issueDate, receiptData.shopName, receiptData.totalPrice);
                    
                    deeplinkOutput.textContent = deeplink;
                    deeplinkButton.href = deeplink;
                    deeplinkCard.classList.remove('hidden'); 
                } else {
                    document.getElementById('deeplink-card').classList.add('hidden'); 
                    document.getElementById('gemini-output-card').classList.add('hidden');
                    document.getElementById('deeplink-output').textContent = 'Deeplink nebol vygenerovaný kvôli chybe pri získavaní dát.';
                }

            } catch(err) {
                console.error("Chyba po spracovaní: ", err);
                document.getElementById('camera-error').textContent = `CHYBA: Nepodarilo sa spracovať kód. ${err.message}`;
                document.getElementById('camera-error').classList.remove('hidden');
            }
        }

        /**
         * Funkcia volaná v prípade chyby skenovania/spustenia kamery.
         * @param {any} errorMessage Popis chyby.
         */
        function onScanFailure(errorMessage) {
             const errorElement = document.getElementById('camera-error');
             const errorString = String(errorMessage); 

             if (!errorString.includes('No MultiFormat Readers')) {
                 console.warn(`QR skenovanie zlyhalo: ${errorString}`);
             }

             if (errorString.includes("NotAllowedError") || errorString.includes("NotFoundError")) {
                 errorElement.textContent = "CHYBA: Kamera nespustená. Skontrolujte, či ste povolili prístup ku kamere a či ju neblokuje iná aplikácia.";
                 errorElement.classList.remove('hidden');
             } else {
                 errorElement.classList.add('hidden');
             }
        }
        
        /**
         * Inicializácia a spustenie skenera.
         */
        function startScanner() {
            // Vyčistenie predchádzajúcich výsledkov
            document.getElementById('qr-content').textContent = 'Čakám na sken...';
            document.getElementById('qr-content').classList.add('text-gray-400');
            document.getElementById('python-output').textContent = 'Výsledok API volania.';
            document.getElementById('python-output').classList.add('text-gray-400');
            document.getElementById('gemini-output').textContent = 'Výsledok kategorizácie AI.';
            document.getElementById('gemini-output').classList.add('text-gray-400');

            // Skryť karty s výsledkami
            document.getElementById('qr-content-card').classList.add('hidden'); 
            document.getElementById('api-output-card').classList.add('hidden'); 
            document.getElementById('gemini-output-card').classList.add('hidden'); 
            document.getElementById('deeplink-card').classList.add('hidden'); 

            document.getElementById('camera-error').classList.add('hidden');

            // Vytvorenie inštancie skenera
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { 
                    fps: 15,
                    qrbox: { width: 200, height: 200 },
                    rememberLastUsedCamera: true,
                    disableFlip: false 
                },
                /* verbose= */ false
            );
            
            // Spustenie skenera
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        // Spustenie aplikácie po načítaní okna
        window.onload = function() {
            // Najprv naplníme dropdown menu, aby boli pripravené
            populateDropdowns(); 
            
            // Až potom spustíme skener
            startScanner();

            // NOVÉ: Nastavenie tlačidla pre manuálne zadanie
            document.getElementById('submit-kb-button').addEventListener('click', handleManualInput);

            // Reštart skenera po kliknutí na Deeplink
            document.getElementById('open-deeplink-button').addEventListener('click', () => {
                // Vyčistíme div pre skener a znova ho spustíme
                document.getElementById('reader').innerHTML = '';
                startScanner();
            });


            // Nastavenie tlačidla pre reset skenovania/reštart
            document.getElementById('reset-button').addEventListener('click', () => {
                if (html5QrcodeScanner) {
                    try {
                        html5QrcodeScanner.clear().catch(e => console.warn("Skener sa nepodarilo zastaviť:", e));
                    } catch (e) {
                        // Ignorujeme, ak už bol zastavený/neúplne inicializovaný
                    }
                }
                
                // Vyčistíme div pre skener a znova ho spustíme
                document.getElementById('reader').innerHTML = '';
                startScanner();
            });

            // *** PWA: REGISTRÁCIA SERVICE WORKERA ***
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker zaregistrovaný: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('Registrácia ServiceWorkera zlyhala: ', err);
                        });
                });
            }

        };

    </script>
</body>
</html>